<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asset Manager</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f6f7;
      margin: 10px;
      font-size: 11px;
    }

    /* .card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px 12px;
      max-width: 700px;
      margin: auto;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    } */

    h2 {
      text-align: center;
      margin-bottom: 8px;
      font-size: 14px;
      color: #333;
    }

    .form-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    label {
      font-weight: 600;
      font-size: 11px;
      margin-right: 3px;
    }

    select,
    input {
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 11px;
      padding: 3px 5px;
      min-width: 90px;
      max-width: 120px;
    }

    #actionBtn {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      font-size: 11px;
      cursor: pointer;
      transition: 0.2s;
    }

    #actionBtn:hover:not(:disabled) {
      background: #005ec5;
    }

    #actionBtn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }

    .msg {
      text-align: center;
      margin: 4px 0;
      font-size: 11px;
    }

    .success {
      color: green;
    }

    .error {
      color: red;
    }
  </style>
</head>

<body>
  <div class="card">
    <!-- <h2>Asset Manager</h2> -->

    <div class="form-row">
      <label for="parentSelect">Parent:</label>
      <select id="parentSelect">
        <option value="">Loading...</option>
      </select>

      <label for="childOrDeviceSelect">Child:</label>
      <select id="childOrDeviceSelect">
        <option value="">Select</option>
        <optgroup label="Asset Types" id="typesGroup"></optgroup>
        <optgroup label="Devices" id="devicesGroup"></optgroup>
      </select>

      <input id="childName" placeholder="Name" style="display: none" />
      <button id="actionBtn" disabled>Run</button>
      <div id="message" class="msg"></div>
    </div>
  </div>

  <script>
    const cfg = {
      base: "https://dev-lighting.iot.etisalat-cloud.com",
      user: "t19885/phoebe.gergis@etisalat.com",
      pass: "root@123",
    };
    const auth = "Basic " + btoa(cfg.user + ":" + cfg.pass);
    const headers = {
      Authorization: auth,
      Accept:
        "application/vnd.com.nsn.cumulocity.managedobjectcollection+json",
    };
    const headersObj = {
      Authorization: auth,
      Accept: "application/vnd.com.nsn.cumulocity.managedobject+json",
    };

    const parentSelect = document.getElementById("parentSelect");
    const childOrDeviceSelect = document.getElementById(
      "childOrDeviceSelect"
    );
    const typesGroup = document.getElementById("typesGroup");
    const devicesGroup = document.getElementById("devicesGroup");
    const childName = document.getElementById("childName");
    const message = document.getElementById("message");
    const actionBtn = document.getElementById("actionBtn");

    let types = [];
    let devicesCache = [];

    const msg = (t, c = "error") => {
      message.innerHTML = `<div class="msg ${c}">${t}</div>`;
      setTimeout(() => (message.innerHTML = ""), 4000);
    };

    const get = async (url) => (await fetch(url, { headers })).json();
    const getObj = async (url) =>
      (await fetch(url, { headers: headersObj })).json();
    const post = async (url, body) =>
      fetch(url, {
        method: "POST",
        headers: {
          ...headersObj,
          "Content-Type":
            "application/vnd.com.nsn.cumulocity.managedobject+json",
        },
        body: JSON.stringify(body),
      });
    const postRef = async (url, id) =>
      fetch(url, {
        method: "POST",
        headers: {
          Authorization: auth,
          "Content-Type":
            "application/vnd.com.nsn.cumulocity.managedobjectreference+json",
        },
        body: JSON.stringify({ managedObject: { id } }),
      });

    async function loadParents() {
      try {
        const d = await get(
          `${cfg.base}/inventory/managedObjects?fragmentType=c8y_IsAsset&pageSize=200`
        );
        parentSelect.innerHTML = '<option value="">Select</option>';
        d.managedObjects.forEach((a) =>
          parentSelect.add(new Option(`${a.name} (${a.id})`, a.id))
        );
      } catch {
        msg("Load parents failed");
      }
    }

    async function loadTypes() {
      try {
        const d = await get(
          `${cfg.base}/inventory/managedObjects?fragmentType=c8y_IsAssetType&pageSize=2000`
        );
        types = await Promise.all(
          d.managedObjects.map((t) =>
            getObj(`${cfg.base}/inventory/managedObjects/${t.id}`)
          )
        );
      } catch {
        msg("Load types failed");
      }
    }

    async function loadDevices() {
      try {
        const d = await get(
          `${cfg.base}/inventory/managedObjects?fragmentType=c8y_IsDevice&pageSize=500`
        );
        devicesCache = d.managedObjects || [];
        devicesGroup.innerHTML = "";
        devicesCache.forEach((x) => {
          const o = document.createElement("option");
          o.value = `dev::${x.id}`;
          o.textContent = `${x.name || "No Name"} (${x.id})`;
          devicesGroup.appendChild(o);
        });
      } catch {
        msg("Load devices failed");
      }
    }

    parentSelect.addEventListener("change", async (e) => {
      typesGroup.innerHTML = "<option>...</option>";
      if (!e.target.value) return;
      try {
        const p = await getObj(
          `${cfg.base}/inventory/managedObjects/${e.target.value}`
        );
        const pt = types.find((t) => t.name === p.type);
        typesGroup.innerHTML = "";
        if (pt?.c8y_IsAssetType?.allowedAssetTypes?.length) {
          pt.c8y_IsAssetType.allowedAssetTypes.forEach((a) => {
            const t = types.find((tt) => tt.id === a.id);
            if (t) {
              const o = document.createElement("option");
              o.value = `type::${t.name}`;
              o.textContent = t.label || t.name;
              typesGroup.appendChild(o);
            }
          });
        } else typesGroup.innerHTML = "<option>None</option>";
      } catch {
        typesGroup.innerHTML = "<option>Error</option>";
      }
      check();
    });

    childOrDeviceSelect.addEventListener("change", () => {
      const v = childOrDeviceSelect.value || "";
      if (v.startsWith("type::")) {
        childName.style.display = "inline-block";
        actionBtn.textContent = "Create & Link";
      } else if (v.startsWith("dev::")) {
        childName.style.display = "none";
        actionBtn.textContent = "Link";
      } else {
        childName.style.display = "none";
        actionBtn.textContent = "Run";
      }
      check();
    });

    const check = () => {
      const v = childOrDeviceSelect.value || "";
      if (!parentSelect.value || !v) return (actionBtn.disabled = true);
      if (v.startsWith("type::"))
        actionBtn.disabled = !childName.value.trim();
      else actionBtn.disabled = false;
    };
    childName.addEventListener("input", check);

    actionBtn.addEventListener("click", async () => {
      const sel = childOrDeviceSelect.value || "";
      if (!sel) return msg("Select type/device");
      if (!parentSelect.value) return msg("Select parent");
      if (sel.startsWith("type::")) createAsset();
      else if (sel.startsWith("dev::")) linkDevice();
    });

    async function createAsset() {
      const pid = parentSelect.value,
        type = childOrDeviceSelect.value.split("::")[1],
        name = childName.value.trim();
      if (!type || !name) return;
      actionBtn.disabled = true;
      const prev = actionBtn.textContent;
      actionBtn.textContent = "Creating...";
      try {
        const t = types.find((x) => x.name === type);
        const asset = {
          name,
          type,
          c8y_IsAsset: {},
          c8y_IsDeviceGroup: {},
          icon: t?.c8y_IsAssetType?.icon,
        };
        const res = await post(`${cfg.base}/inventory/managedObjects`, asset);
        if (!res.ok) throw new Error("Create failed");
        let id;
        try {
          const j = await res.json();
          id = j.id;
        } catch {
          const loc = res.headers.get("Location");
          if (loc) id = loc.split("/").pop();
        }
        await postRef(
          `${cfg.base}/inventory/managedObjects/${pid}/childAssets`,
          id
        );
        msg(`Done`, "success");
        await loadParents();
        childName.value = "";
        childOrDeviceSelect.selectedIndex = 0;
        check();
      } catch (e) {
        msg(e.message);
      } finally {
        actionBtn.disabled = false;
        actionBtn.textContent = prev;
      }
    }

    async function linkDevice() {
      const pid = parentSelect.value,
        did = childOrDeviceSelect.value.split("::")[1];
      if (!did) return msg("No device");
      actionBtn.disabled = true;
      const prev = actionBtn.textContent;
      actionBtn.textContent = "Linking...";
      try {
        const d = await getObj(`${cfg.base}/inventory/managedObjects/${did}`);
        if (!d.c8y_IsAsset) {
          const add = await fetch(
            `${cfg.base}/inventory/managedObjects/${did}`,
            {
              method: "PUT",
              headers: {
                ...headersObj,
                "Content-Type":
                  "application/vnd.com.nsn.cumulocity.managedobject+json",
              },
              body: JSON.stringify({ c8y_IsAsset: {} }),
            }
          );
          if (!add.ok) throw new Error("Mark fail");
        }
        await postRef(
          `${cfg.base}/inventory/managedObjects/${pid}/childAssets`,
          did
        );
        msg("Done", "success");
        childOrDeviceSelect.selectedIndex = 0;
        check();
      } catch (e) {
        msg(e.message);
      } finally {
        actionBtn.disabled = false;
        actionBtn.textContent = prev;
      }
    }

    (async () => {
      await Promise.all([loadParents(), loadTypes(), loadDevices()]);
      check();
    })();
  </script>
</body>

</html>