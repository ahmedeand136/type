<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asset Manager</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 15px;
      font-size: 12px;
    }

    .container {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.1);
      max-width: 500px;
      margin: auto;
    }

    h2 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 14px;
    }

    label {
      font-weight: bold;
      font-size: 11px;
      white-space: nowrap;
    }

    select,
    input {
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 11px;
    }

    button {
      display: block;
      width: 100%;
      padding: 6px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }

    .success {
      color: green;
      margin-bottom: 5px;
      text-align: center;
      font-size: 11px;
    }

    .error {
      color: red;
      margin-bottom: 5px;
      text-align: center;
      font-size: 11px;
    }

    .inline-selects {
      display: flex;
      align-items: center;
      gap: 5px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .inline-selects select {
      flex: 1;
      min-width: 100px;
      max-width: 180px;
    }

    #childName {
      width: 100%;
      margin-top: 4px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Asset Management</h2>
    <div id="message"></div>

    <div class="form-group inline-selects">
      <label for="parentSelect">Parent:</label>
      <select id="parentSelect">
        <option value="">-- Loading --</option>
      </select>

      <label for="childOrDeviceSelect">Child / Device:</label>
      <select id="childOrDeviceSelect">
        <option value="">-- Select type or device --</option>
        <optgroup label="Asset Types" id="typesGroup"></optgroup>
        <optgroup label="Devices" id="devicesGroup"></optgroup>
      </select>
    </div>

    <div id="nameBlock" class="form-group">
      <label for="childName">Child Name:</label>
      <input id="childName" placeholder="Enter child or device name" />
    </div>

    <button id="actionBtn" disabled>Execute</button>
  </div>

  <script>
    const cfg = {
      base: 'https://dev-lighting.iot.etisalat-cloud.com',
      user: 't19885/phoebe.gergis@etisalat.com',
      pass: 'root@123'
    };
    const auth = 'Basic ' + btoa(cfg.user + ':' + cfg.pass);
    const headers = { 'Authorization': auth, 'Accept': 'application/vnd.com.nsn.cumulocity.managedobjectcollection+json' };
    const headersObj = { 'Authorization': auth, 'Accept': 'application/vnd.com.nsn.cumulocity.managedobject+json' };

    const parentSelect = document.getElementById('parentSelect');
    const childOrDeviceSelect = document.getElementById('childOrDeviceSelect');
    const typesGroup = document.getElementById('typesGroup');
    const devicesGroup = document.getElementById('devicesGroup');
    const childName = document.getElementById('childName');
    const nameBlock = document.getElementById('nameBlock');
    const message = document.getElementById('message');
    const actionBtn = document.getElementById('actionBtn');

    let types = [];
    let devicesCache = [];

    function showMsg(txt, cls = 'error') {
      message.innerHTML = `<div class="${cls}">${txt}</div>`;
      setTimeout(() => { message.innerHTML = ''; }, 5000);
    }

    async function get(url) { return (await fetch(url, { headers })).json(); }
    async function getObj(url) { return (await fetch(url, { headers: headersObj })).json(); }
    async function post(url, body) {
      return fetch(url, {
        method: 'POST',
        headers: { ...headersObj, 'Content-Type': 'application/vnd.com.nsn.cumulocity.managedobject+json' },
        body: JSON.stringify(body)
      });
    }
    async function postRef(url, id) {
      return fetch(url, {
        method: 'POST',
        headers: { 'Authorization': auth, 'Content-Type': 'application/vnd.com.nsn.cumulocity.managedobjectreference+json' },
        body: JSON.stringify({ managedObject: { id } })
      });
    }

    async function loadParents() {
      try {
        const data = await get(`${cfg.base}/inventory/managedObjects?fragmentType=c8y_IsAsset&pageSize=200`);
        parentSelect.innerHTML = '<option value="">-- Select Parent --</option>';
        data.managedObjects.forEach(a => parentSelect.appendChild(new Option(`${a.name || 'No Name'} (${a.id})`, a.id)));
      } catch (e) { showMsg('Failed to load parents'); }
    }

    async function loadTypes() {
      try {
        const data = await get(`${cfg.base}/inventory/managedObjects?fragmentType=c8y_IsAssetType&pageSize=2000&withChildren=true`);
        types = await Promise.all(data.managedObjects.map(t => getObj(`${cfg.base}/inventory/managedObjects/${t.id}`)));
      } catch (e) { showMsg('Failed to load types'); }
    }

    async function loadDevices() {
      try {
        const data = await get(`${cfg.base}/inventory/managedObjects?fragmentType=c8y_IsDevice&pageSize=500`);
        devicesCache = data.managedObjects || [];
        devicesGroup.innerHTML = '';
        devicesCache.forEach(d => {
          const opt = document.createElement('option');
          opt.value = `dev::${d.id}`;
          opt.textContent = `${d.name || 'No Name'} (${d.id})`;
          devicesGroup.appendChild(opt);
        });
      } catch (e) { showMsg('Failed to load devices'); }
    }

    parentSelect.addEventListener('change', async (ev) => {
      typesGroup.innerHTML = '<option>-- Loading --</option>';
      if (!ev.target.value) {
        typesGroup.innerHTML = '<option>-- Select parent first --</option>';
        return;
      }
      try {
        const parent = await getObj(`${cfg.base}/inventory/managedObjects/${ev.target.value}`);
        const pType = types.find(t => t.name === parent.type);
        typesGroup.innerHTML = '';
        if (pType?.c8y_IsAssetType?.allowedAssetTypes?.length) {
          pType.c8y_IsAssetType.allowedAssetTypes.forEach(a => {
            const target = types.find(t => t.id === a.id);
            if (target) {
              const opt = document.createElement('option');
              opt.value = `type::${target.name}`;
              opt.textContent = target.label || target.name;
              typesGroup.appendChild(opt);
            }
          });
        } else typesGroup.innerHTML = '<option>-- No types --</option>';
      } catch (err) {
        typesGroup.innerHTML = '<option>-- Error loading types --</option>';
      }
      updateActionState();
    });

    childOrDeviceSelect.addEventListener('change', () => {
      updateUIForSelection();
      updateActionState();
    });

    function updateUIForSelection() {
      const v = childOrDeviceSelect.value || '';
      if (v.startsWith('type::')) {
        nameBlock.style.display = 'block';
        childName.disabled = false;
        actionBtn.textContent = 'Create & Link';
      } else if (v.startsWith('dev::')) {
        nameBlock.style.display = 'none';
        childName.disabled = true;
        actionBtn.textContent = 'Link Device';
      } else {
        nameBlock.style.display = 'block';
        childName.disabled = false;
        actionBtn.textContent = 'Execute';
      }
    }

    function updateActionState() {
      const v = childOrDeviceSelect.value || '';
      if (!parentSelect.value || !v) return actionBtn.disabled = true;
      if (v.startsWith('type::')) actionBtn.disabled = !childName.value.trim();
      else actionBtn.disabled = false;
    }

    childName.addEventListener('input', updateActionState);
    parentSelect.addEventListener('change', updateActionState);

    actionBtn.addEventListener('click', async () => {
      const sel = childOrDeviceSelect.value || '';
      if (!sel) return showMsg('Select type or device');
      if (!parentSelect.value) return showMsg('Select parent first');
      if (sel.startsWith('type::')) await handleCreateAssetFromType();
      else if (sel.startsWith('dev::')) await handleAssignDevice();
    });

    async function handleCreateAssetFromType() {
      const parentId = parentSelect.value;
      const typeName = childOrDeviceSelect.value.split('::')[1];
      const name = childName.value.trim();
      if (!name) return showMsg('Enter name');
      actionBtn.disabled = true;
      const prevTxt = actionBtn.textContent;
      actionBtn.textContent = 'Creating...';
      try {
        const typeDef = types.find(t => t.name === typeName);
        const asset = { name, type: typeName, c8y_IsAsset: {}, c8y_IsDeviceGroup: {} };
        const res = await post(`${cfg.base}/inventory/managedObjects`, asset);
        const json = await res.json();
        const id = json.id;
        await postRef(`${cfg.base}/inventory/managedObjects/${parentId}/childAssets`, id);
        showMsg(`âœ… Created & linked "${name}" (ID: ${id})`, 'success');
        childName.value = '';
        childOrDeviceSelect.selectedIndex = 0;
      } catch (err) { showMsg('Error: ' + err.message); }
      finally { actionBtn.disabled = false; actionBtn.textContent = prevTxt; }
    }

    async function handleAssignDevice() {
      const parentId = parentSelect.value;
      const deviceId = childOrDeviceSelect.value.split('::')[1];
      if (!deviceId) return showMsg('No device selected');
      actionBtn.disabled = true;
      const prevTxt = actionBtn.textContent;
      actionBtn.textContent = 'Linking...';
      try {
        const device = await getObj(`${cfg.base}/inventory/managedObjects/${deviceId}`);
        if (!device.c8y_IsAsset) {
          await fetch(`${cfg.base}/inventory/managedObjects/${deviceId}`, {
            method: 'PUT',
            headers: { ...headersObj, 'Content-Type': 'application/vnd.com.nsn.cumulocity.managedobject+json' },
            body: JSON.stringify({ c8y_IsAsset: {} })
          });
        }
        await postRef(`${cfg.base}/inventory/managedObjects/${parentId}/childAssets`, deviceId);
        showMsg('âœ… Device linked', 'success');
        childOrDeviceSelect.selectedIndex = 0;
      } catch (err) { showMsg('Error: ' + err.message); }
      finally { actionBtn.disabled = false; actionBtn.textContent = prevTxt; }
    }

    (async () => {
      await Promise.all([loadParents(), loadTypes(), loadDevices()]);
      updateUIForSelection();
      updateActionState();
    })();
  </script>
</body>

</html>
